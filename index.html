<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI School Management</title>
<link rel="stylesheet" href="style.css">
<style>
body{font-family:sans-serif;background:#f2f2f2;margin:0}
header{background:#1976ff;color:#fff;padding:12px;text-align:center}
nav{background:#fff;padding:10px;display:flex;gap:10px;justify-content:center;border-bottom:1px solid #ddd}
button,a{padding:8px 14px;border:none;background:#1976ff;color:#fff;border-radius:5px;cursor:pointer;text-decoration:none;font-weight:bold}
a{background:#444}
.page{display:none;padding:20px}
.show{display:block}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #ddd}
.hidden{display:none}
input,select{padding:8px;width:100%;margin-top:5px;margin-bottom:10px;border-radius:5px;border:1px solid #aaa}
pre{background:#000;color:#0f0;padding:10px}
#chatAI{position:fixed;bottom:18px;right:18px;background:#fff;padding:10px;border-radius:8px;width:270px;height:330px;border:2px solid #1976ff;display:none;flex-direction:column}
#chatAI textarea{flex:1;margin-top:8px}
#chatAI-toggle{position:fixed;bottom:20px;right:20px;background:#ff4081;color:#fff;padding:14px;border-radius:50%;cursor:pointer;font-size:20px}
</style>
</head>

<body>

<header>
  <h2>AI SCHOOL MANAGEMENT SYSTEM</h2>
  <div id="user-status">â³ Äang kiá»ƒm tra Ä‘Äƒng nháº­p...</div>
</header>

<nav>
  <button onclick="show('login-page')">ğŸ”‘ ÄÄƒng nháº­p</button>
  <button onclick="show('dashboard')">ğŸ“Š Dashboard</button>
  <a href="chat.html">ğŸ’¬ Chat ToÃ n TrÆ°á»ng</a>
  <a href="wheel.html">VÃ²ng quay may máº¯n</a>
</nav>


<!-- LOGIN + REGISTER -->
<section id="login-page" class="page show">
<div class="card">
<h3>ÄÄƒng nháº­p</h3>
<input id="login-email" placeholder="Email">
<input id="login-pass" type="password" placeholder="Máº­t kháº©u">
<button id="btn-login">ÄÄƒng nháº­p</button>
</div>

<div class="card">
<h3>Táº¡o tÃ i khoáº£n má»›i</h3>
<input id="reg-name" placeholder="Há» tÃªn">
<input id="reg-email" placeholder="Email">
<input id="reg-pass" type="password" placeholder="Máº­t kháº©u">
<select id="reg-role">
<option value="student">Há»c sinh</option>
<option value="teacher">GiÃ¡o viÃªn</option>
<option value="principal">Hiá»‡u trÆ°á»Ÿng</option>
</select>
<button id="btn-register">ÄÄƒng kÃ½</button>
</div>
</section>



<!-- DASHBOARD -->
<section id="dashboard" class="page">

<h2>ğŸ“Œ Báº£ng Ä‘iá»u khiá»ƒn</h2>
<p>Chá»©c nÄƒng tÃ¹y thuá»™c vÃ o loáº¡i tÃ i khoáº£n Ä‘Äƒng nháº­p</p>
<hr>

<!-- ================= HIá»†U TRÆ¯á»NG ================= -->
<div id="panel-principal" class="card hidden">
<h3>ğŸ« Hiá»‡u trÆ°á»Ÿng quáº£n lÃ½ trÆ°á»ng & lá»›p</h3>

<input id="school-name" placeholder="Nháº­p tÃªn trÆ°á»ng...">
<button onclick="addSchool()">â• ThÃªm trÆ°á»ng</button>

<h4>Danh sÃ¡ch trÆ°á»ng</h4>
<div id="school-list"></div>

<h4>Táº¡o lá»›p má»›i</h4>
<select id="select-school"></select>
<input id="class-name" placeholder="VD: 9A1">
<button onclick="addClass()">â• ThÃªm lá»›p</button>
</div>



<!-- ================= GIÃO VIÃŠN ================= -->
<div id="panel-teacher" class="card hidden">

<h3>ğŸ“˜ GiÃ¡o viÃªn quáº£n lÃ½ lá»›p & Ä‘iá»ƒm</h3>

<select id="t-school"></select>
<select id="t-class"></select>

<!-- Add Multiple students -->
<textarea id="student-bulk" placeholder="Nháº­p danh sÃ¡ch há»c sinh má»—i dÃ²ng 1 tÃªn..."></textarea>
<button onclick="addStudents()">â• ThÃªm danh sÃ¡ch há»c sinh</button>

<h4>Nháº­p Ä‘iá»ƒm cho tá»«ng há»c sinh</h4>
<input id="st-name" placeholder="TÃªn há»c sinh">
<input id="st-score" placeholder="Äiá»ƒm (8.5)">
<button onclick="addScore()">ğŸ’¾ LÆ°u Ä‘iá»ƒm</button>

<h4>DANH SÃCH - NHáº¤N TÃŠN Äá»‚ Sá»¬A</h4>
<div id="class-students"></div>

</div>



<!-- ================= Há»ŒC SINH ================= -->
<div id="panel-student" class="card hidden">
<h3>ğŸ’ Äiá»ƒm sá»‘ cá»§a báº¡n</h3>
<button onclick="loadMyScore()">Xem Ä‘iá»ƒm</button>
<pre id="my-score"></pre>
</div>


<button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
</section>




<!-- ================= POPUP AI CHAT ================= -->
<!-- <div id="chatAI">
<b>AI há»— trá»£ giÃ¡o viÃªn ğŸ§ </b>
<textarea id="ai-in" placeholder="Nháº­p tÃªn HS + nháº­n xÃ©t..."></textarea>
<button onclick="aiEval()">PhÃ¢n tÃ­ch AI</button>
<pre id="ai-out"></pre>
</div>

<button id="chatAI-toggle" onclick="toggleAI()">ğŸ¤–</button> -->




<script type="module">
/* ===================================================== *
 * ğŸ”¥ FIREBASE INIT
 * ===================================================== */
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut}
 from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {getFirestore,doc,setDoc,getDoc,updateDoc,addDoc,getDocs,collection,arrayUnion}
 from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyBc8H5YOYIyQ035kowGn00KdqxK0JzGhlk",
 authDomain:"quan-ly-lop-hoc-14fb6.firebaseapp.com",
 projectId:"quan-ly-lop-hoc-14fb6"
});

const auth = getAuth(app);
const db   = getFirestore(app);
const $=id=>document.getElementById(id);


/* ===================================================== *
 * ğŸ”¥ LOGIN + REGISTER
 * ===================================================== */
$("btn-register").onclick=async()=>{
try{
const u=await createUserWithEmailAndPassword(auth,$("reg-email").value,$("reg-pass").value);
await setDoc(doc(db,"users",u.user.uid),{
 name:$("reg-name").value,email:$("reg-email").value,role:$("reg-role").value
});
alert("Táº¡o tÃ i khoáº£n thÃ nh cÃ´ng");
show("dashboard");
}catch(e){alert(e.message);}
};

$("btn-login").onclick=()=>signInWithEmailAndPassword(auth,$("login-email").value,$("login-pass").value).catch(()=>alert("Sai máº­t kháº©u"));


/* ===================================================== *
 * ğŸ”¥ AUTH CHANGE
 * ===================================================== */
onAuthStateChanged(auth, async user=>{
if(!user) return show("login-page");

let info=await getDoc(doc(db,"users",user.uid));
let u=info.data();

$("user-status").innerHTML=`ğŸ‘‹ Xin chÃ o <b>${u.name}</b> â€” ${u.role}`;
show("dashboard");

/* ROLE DISPLAY */
$("panel-principal").classList.toggle("hidden",u.role!=="principal");
$("panel-teacher").classList.toggle("hidden",u.role!=="teacher");
$("panel-student").classList.toggle("hidden",u.role!=="student");

if(u.role==="principal") loadSchools();
if(u.role==="teacher") loadTeachClasses();
if(u.role==="student") loadMyScore();
});


/* ===================================================== *
 * ğŸ« HIá»†U TRÆ¯á»NG: QUáº¢N LÃ TRÆ¯á»œNG/Lá»šP
 * ===================================================== */
async function addSchool(){
await addDoc(collection(db,"schools"),{name:$("school-name").value,classes:[]});
$("school-name").value="";
loadSchools();
}

async function loadSchools(){
$("school-list").innerHTML="â³ Loading...";
const list=await getDocs(collection(db,"schools"));
$("select-school").innerHTML="";
list.forEach(s=>{$("school-list").innerHTML+=`ğŸ“ ${s.data().name}<br>`;});
}

async function addClass(){
let id=$("select-school").value;
await updateDoc(doc(db,"schools",id),{classes:arrayUnion({name:$("class-name").value,students:[]})});
$("class-name").value="";
alert("ÄÃ£ táº¡o lá»›p");
}


/* ===================================================== *
 * ğŸ‘¨â€ğŸ« GIÃO VIÃŠN: THÃŠM Há»ŒC SINH + NHáº¬P NHIá»€U ÄIá»‚M
 * ===================================================== */
let currentClassID="";

async function loadTeachClasses(){
const list=await getDocs(collection(db,"schools"));
$("t-school").innerHTML="";$("t-class").innerHTML="";
list.forEach(s=>{
 let d=s.data();
 d.classes?.forEach(c=>{
   $("t-school").innerHTML+=`<option>${d.name}</option>`;
   $("t-class").innerHTML+=`<option>${c.name}</option>`;
 });
});
}

async function addStudents(){
let school=$("t-school").value;
let className=$("t-class").value;

const docs=await getDocs(collection(db,"schools"));
docs.forEach(async d=>{
let sc=d.data();
if(sc.name===school){
let cls=sc.classes.find(c=>c.name==className);
$("student-bulk").value.split("\n").forEach(n=>cls.students.push({name:n.trim(),scores:[]}));
await updateDoc(doc(db,"schools",d.id),{classes:sc.classes});
alert("ÄÃ£ thÃªm há»c sinh");
}
});
}

async function addScore(){
let st=$("st-name").value.trim();
let score=$("st-score").value;
let school=$("t-school").value;
let className=$("t-class").value;

const docs=await getDocs(collection(db,"schools"));
docs.forEach(async d=>{
let sc=d.data();
let cls=sc.classes.find(c=>c.name==className);
let hs=cls.students.find(s=>s.name==st);

if(hs){hs.scores.push(Number(score));alert("ÄÃ£ cáº­p nháº­t");}
await updateDoc(doc(db,"schools",d.id),{classes:sc.classes});
});
}


/* ===================================================== *
 * ğŸ§  AI CHAT POP-UP
 * ===================================================== */
function toggleAI(){ $("chatAI").style.display=$("chatAI").style.display==="flex"?"none":"flex"; }

function aiEval(){
let t=$("ai-in").value;
$("ai-out").innerText="ğŸ“Œ AI phÃ¢n tÃ­ch: "+t+"\nâ€¢ Há»c lá»±c tá»‘t\nâ€¢ NÃªn rÃ¨n luyá»‡n thÃªm\nâ€¢ CÃ³ tiá»m nÄƒng phÃ¡t triá»ƒn cao";
}

/* ===================================================== */
function logout(){ signOut(auth); }
function show(id){document.querySelectorAll(".page").forEach(p=>p.classList.remove("show"));$(id).classList.add("show");}

</script>

</body>
</html>
